---
title: "3meta BRMS"
author: "Shari Liu"
date: "2/22/2022"
output: html_document
---

```{r setup, include=FALSE}
options(scipen = 999, digits = 4)
knitr::opts_chunk$set(comment = "#")
r = getOption("repos")
r["CRAN"] = "http://cran.us.r-project.org"

options(repos = r)

## load required packages
ipak <- function (pkg) {
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}

packages <- c("tidyverse", "lsmeans", "influence.ME", "lme4", "effects", "lmerTest", "cowplot", "irr", "simr", "patchwork", "wesanderson", "devtools", "effectsize", "mice", "rstan", "brms", "bayestestR", "rstanarm", "shinystan")

ipak(packages)
set.seed(429)

# set summed contrasts
options(contrasts = c("contr.sum", "contr.poly")) 

# fix bs with dplyr 
detach("package:dplyr", unload = TRUE)
library("dplyr")
```

```{r}
ind.data.init <- read.csv("./fulldata.csv", header=TRUE)
str(ind.data.init)
num_cols <- c("ageday", "exp_look", "unexp_look", "look_pref")
factor_cols <- setdiff(colnames(ind.data.init), num_cols)

ind.data <- ind.data.init %>%
  mutate_at(factor_cols,as.factor)
str(ind.data)

constraints <- ind.data %>% filter(task =="constraints")
goals <- ind.data %>% filter(task =="goals")
constraints <- ind.data %>% filter(task =="constraints")

# checking ref levels for all factors
constraints$actor_hand <- factor(constraints$actor_hand, levels=c("bare", "gloved", "mittened")) # for summed contr last level is dropped
constraints$action_consequence <- relevel(constraints$action_consequence, ref = "state_change")
constraints$agent_efficient_fam <- relevel(constraints$agent_efficient_fam, ref = "yes")
constraints$training_yesno <- relevel(constraints$training_yesno, ref = "yes")
constraints$action_causal <- relevel(constraints$action_causal, ref = "yes")

goals$action_consequence <- relevel(goals$action_consequence, ref = "none")
goals$agent <- factor(goals$agent, levels=c("object", "person", "hand")) # last level gets dropped in model estimates
goals$training_yesno <- relevel(goals$training_yesno, ref = "yes")
goals$bothobjects_present_visible_fam <- relevel(goals$bothobjects_present_visible_fam, ref = "yes")
```

## Various attempts to make the frequentist setting work (not successful)
```{r, eval=FALSE}

# trying to figure out whether random slopes are possible in the frequentist setting
constraints.e1 <- lmer(data = constraints,
     formula = look_pref ~  training_yesno + action_causal + action_consequence + actor_hand + agent_efficient_fam + scale(ageday)  + (1+experiment|paper), 
     control = lmerControl(optimizer="bobyqa"))

summary(constraints.e1)


cooks.constraints.e1 <- cooks.distance(constraints.e1, group = "subj")
dotplot_diag(x = cooks.constraints.e1, cutoff = "internal", name = "cooks.distance",  index=constraints$subj) + ylab("Cook's distance") + xlab("subjID")

constraints.e1.cooks <- constraints[which(cooks.constraints.e1 <= 4/264),]

constraints.e1.aftercooks <- lmer(data = constraints.e1.cooks,
     formula = look_pref ~  training_yesno + action_causal + action_consequence + actor_hand + agent_efficient_fam + scale(ageday)  + (1+experiment|paper), 
     control = lmerControl(optimizer="bobyqa"))

summary(constraints.e1.aftercooks)

# try other optimizers
constraints.e1.all <- allFit(constraints.e1)
summary(constraints.e1.all)
```

```{r, eval=FALSE}
constraints.full.e1 <- lmer(data = constraints,
     formula = look_pref ~  training_yesno + action_causal + action_consequence + actor_hand + agent_efficient_fam + scale(ageday) + (1+experiment|paper), REML=FALSE, lmerControl(optimizer="bobyqa")) # REML set to false to enable model comparison via likelihood methods, change optimizer to Nelder Mead to deal with failures to converge

constraints.predictors=c("training_yesno","action_causal","action_consequence","actor_hand","agent_efficient_fam","ageday")

constraints.bf.e1 <- data.frame(constraints.predictors) %>%
  mutate(BF.cooks = NA,
         Interpretation.Cooks = NA) %>%
  rename(Fixed.Effect = constraints.predictors)

for (predictor in constraints.predictors) {
  modelform <- update(constraints.full.e1, as.formula(paste0(". ~ . -",predictor)))
  BF <- exp((BIC(modelform) - BIC(constraints.full.e1))/2)
  whichrow <- which(constraints.bf.e1$Fixed.Effect == as.character(predictor))
  constraints.bf.e1[whichrow,2] <- BF
  constraints.bf.e1[whichrow,3] <- interpret_bf(BF)
}

constraints.bf.e1
```

```{r, eval=FALSE}
# trying to figure out whether random slopes are possible in the frequentist setting
goals.e1 <- lmer(data = goals,
     formula = look_pref ~ training_yesno  + action_consequence + location_object_goal_ambiguous + agent + bothobjects_present_visible_fam +  scale(ageday)  + (1+experiment|paper), 
     control = lmerControl(optimizer="Nelder_Mead"))

cooks.goals.e1 <- cooks.distance(goals.e1, group = "subj")
dotplot_diag(x = cooks.goals.e1, cutoff = "internal", name = "cooks.distance",  index=goals$subj) + ylab("Cook's distance") + xlab("subjID")

goals.e1.cooks <- goals[which(cooks.goals.e1 <= 4/386),]

goals.e1.aftercooks <- lmer(data = goals.e1.cooks,
     formula = look_pref ~ training_yesno  + action_consequence + location_object_goal_ambiguous + agent + bothobjects_present_visible_fam +  scale(ageday)  + (1+experiment|paper), 
     control = lmerControl(optimizer="Nelder_Mead"))

summary(goals.e1.aftercooks)
plot(allEffects(goals.e1.aftercooks))
```

## Impute Sommerville Data
```{r}

# 0_pilotnotraining
# n = 16, mean age = 106.54
# UNEXP, M = 53.9, SD = 14.9
# EXP, M = 47.1, SD = 12.4

# 1_watchfirst
# n = 15, mean age = 101.32
# UNEXP, M = 33.781, SD = 7.283212518
# EXP, M = 33.417, SD = 4.740388137
# t = 0.9

# 1_reachfirst
# n = 15, mean age = 104.32
# UNEXP, M = 53.992, SD = 11.10689909
# EXP, M = 30.504, SD = 4.369927511
# t = 2.6

ind.data.long %>%
  filter(PI_group=="woodward") %>%
  ggplot(aes(look_sec)) +
  geom_histogram()

v1 <- rlnorm(16, meanlog=3.987, sdlog=.25)
mean(v1)
sd(v1)

v2 <- rlnorm(16, meanlog=3.852, sdlog=.24)
mean(v2)
sd(v2)

ind.data.long$look_log

t.test(v1,v2, paired = TRUE)
```

## BRMS
In the primary analysis, we chose to pare down the random effects structure to just random intercepts for conditions, experiments, and papers, in order to deal with issues of convergence. Nevertheless, such an analytical choice neglects the correlated methodological decisions shared by conditions and experiments within papers, and leaves open the possibility that some of the effects we fit were driven by just a few conditions. When we explored ways of fitting frequentist models with alternative ways of specifying the random effects, and iteratively computing Bayes Factors like we did above, we never found a set of optimizers and random effects specifications that consistently converged. Thus, for an exploratory analysis we decided to refit the models from the confirmatory analysis with the full random effects structure using brms. 

### Constraints Task
```{r, eval=FALSE}
hist(constraints$look_pref)

##  not run, uncomment to reproduce results
# constraints.brms.intercept <- brm(formula = look_pref ~ 1 + ageday + (1|condition) + (1+condition|experiment) + (1+condition|paper),
#                 data= constraints, 
#                 warmup = 1000, 
#                 iter   = 5000, 
#                 family = gaussian(link="identity"),
#                 chains = 6, 
#                 thin = 2,
#                 seed = 429,
#                 save_all_pars = TRUE,
#                 sample_prior = TRUE,
#                 control = list(adapt_delta = .98))
# saveRDS(constraints.brms.intercept,file="constraints.brms.intercept.rds")

constraints.brms.intercept <- readRDS("constraints.brms.intercept.rds")
shinystan::launch_shinystan(constraints.brms.intercept)
summary(constraints.brms.intercept)
hypothesis(constraints.brms.intercept, "Intercept > 0", alpha=.05)

hypothesis_vector <- c("ageday > 0",
                       "training_yesno1 > 0",
                       "action_causal1 > 0",
                       "action_consequence1 > 0",
                       "actor_hand1 > 0",
                       "actor_hand2 > 0", 
                       "agent_efficient_fam1 > 0"
            )
# constraints.brms.full <- update(constraints.brms.intercept,
#                                 newdata = constraints,
#                                 formula. = ~ . +  training_yesno + action_causal + action_consequence + actor_hand + agent_efficient_fam)
# saveRDS(constraints.brms.full,file="constraints.brms.full.rds")
constraints.brms.full <- readRDS("constraints.brms.full.rds")
shinystan::launch_shinystan(constraints.brms.full)
summary(constraints.brms.full)

hypothesis(constraints.brms.full, hypothesis_vector, seed = 429, alpha=.05)

# constraints.brms.full.simplerfx <- brm(formula = look_pref ~ training_yesno + action_causal + action_consequence + actor_hand + agent_efficient_fam + ageday + (1|condition) + (1|experiment) + (1|paper),
#                 data= constraints,
#                 warmup = 1000,
#                 iter   = 5000,
#                 family = gaussian(link="identity"),
#                 chains = 6,
#                 thin = 2,
#                 seed = 429,
#                 save_all_pars = TRUE,
#                 sample_prior = TRUE,
#                 control = list(adapt_delta = .98))
# saveRDS(constraints.brms.full.simplerfx,file="constraints.brms.full.simplerfx.rds")
constraints.brms.full.simplerfx <- readRDS("constraints.brms.full.simplerfx.rds")
shinystan::launch_shinystan(constraints.brms.full.simplerfx)

constraints.results.full <- hypothesis(constraints.brms.full, hypothesis_vector, seed = 429, alpha=.05) 
constraints.results.simplerfx <- hypothesis(constraints.brms.full.simplerfx, hypothesis_vector, seed = 429, alpha=.05)

```

```{r}
#  not run, uncomment to reproduce results
# goals.brms.intercept <- brm(formula = look_pref ~ 1 + ageday + (1|condition) + (1+condition|experiment) + (1+condition|paper),
#                 data= goals,
#                 warmup = 1000,
#                 iter   = 5000,
#                 family = gaussian(link="identity"),
#                 chains = 6,
#                 thin = 2,
#                 seed = 429,
#                 save_all_pars = TRUE,
#                 sample_prior = TRUE,
#                 control = list(adapt_delta = .98))
# saveRDS(goals.brms.intercept,file="goals.brms.intercept.rds")
goals.brms.intercept <- readRDS("goals.brms.intercept.rds")
shinystan::launch_shinystan(goals.brms.intercept)
summary(goals.brms.intercept)
hypothesis(goals.brms.intercept, "Intercept > 0", alpha=.05)

hypothesis_vector <- c("ageday > 0",
                       "training_yesno1 > 0",
                       "location_object_goal_ambiguous1 > 0",
                       "action_consequence1 > 0",
                       "agent1 > 0",
                       "agent2 > 0", 
                       "bothobjects_present_visible_fam1 > 0"
            )

# goals.brms.full <- update(goals.brms.intercept,
#                                 newdata = goals,
#                                 formula. = ~ . +  training_yesno + agent + action_consequence + bothobjects_present_visible_fam + location_object_goal_ambiguous)
# saveRDS(goals.brms.full,file="goals.brms.full.rds")
shinystan::launch_shinystan(goals.brms.full)
summary(goals.brms.full)
hypothesis(goals.brms.full, hypothesis_vector, seed = 429, alpha=.05) 


# goals.brms.full.simplefx  <- brm(formula = look_pref ~ training_yesno + agent + action_consequence + bothobjects_present_visible_fam + location_object_goal_ambiguous + ageday + (1|condition) + (1|experiment) + (1|paper),
#                 data= goals,
#                 warmup = 1000,
#                 iter   = 5000,
#                 family = gaussian(link="identity"),
#                 chains = 6,
#                 thin = 2,
#                 seed = 429,
#                 save_all_pars = TRUE,
#                 sample_prior = TRUE,
#                 control = list(adapt_delta = .98))
saveRDS(goals.brms.full.simplefx,file="goals.brms.full.simplefx.rds")
shinystan::launch_shinystan(goals.brms.full.simplefx)
summary(goals.brms.full.simplefx)

hypothesis(goals.brms.full.simplefx, hypothesis_vector, seed = 429, alpha=.05) 

```

